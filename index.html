<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>US History Map ‚Äî Enhanced</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  
  :root { 
    --primary-blue: #2563eb;
    --primary-blue-light: #3b82f6;
    --panel-bg: rgba(255, 255, 255, 0.98);
    --panel-border: rgba(255, 255, 255, 0.3);
    --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.1);
    --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.15);
    --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --state-color: #10b981;
    --state-hover: #059669;
    --territory-color: #f59e0b;
    --territory-hover: #d97706;
    --event-color: #ef4444;
    --event-hover: #dc2626;
    --confederate-color: #dc2626;
    --confederate-hover: #b91c1c;
    --panel-height: 140px;
  }
  
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; padding: 0; }
  
  body { 
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    background: var(--gradient-bg);
    overflow: hidden;
  }
  
  #panel { 
    position: fixed; 
    left: 20px; 
    top: 20px; 
    right: 360px;
    height: var(--panel-height);
    background: var(--panel-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--panel-border);
    padding: 24px; 
    border-radius: 16px; 
    box-shadow: var(--shadow-medium);
    z-index: 20; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  #panel:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
  }
  
  .panel-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 16px 0;
    letter-spacing: -0.5px;
  }
  
  .year-control {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 14px;
  }
  
  .year-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    min-width: 40px;
  }
  
  #year {
    flex: 1;
    height: 8px;
    border-radius: 4px;
    background: #e5e7eb;
    outline: none;
    appearance: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  #year::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary-blue);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    transition: all 0.2s ease;
  }
  
  #year::-webkit-slider-thumb:hover {
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5);
  }
  
  #year::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary-blue);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
  }
  
  #yearValue { 
    font-weight: 700;
    font-size: 18px;
    color: var(--primary-blue);
    min-width: 70px;
    text-align: center;
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid rgba(37, 99, 235, 0.2);
    border-radius: 8px;
    padding: 6px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  #yearValue:hover {
    background: white;
    border-color: var(--primary-blue);
    transform: translateY(-1px);
  }
  
  #yearInput {
    display: none;
    font-weight: 700;
    font-size: 18px;
    color: var(--primary-blue);
    width: 90px;
    text-align: center;
    background: white;
    border: 2px solid var(--primary-blue);
    border-radius: 8px;
    padding: 6px 12px;
    outline: none;
    font-family: 'Inter', sans-serif;
  }
  
  #yearInput::-webkit-outer-spin-button,
  #yearInput::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  #yearInput[type=number] {
    -moz-appearance: textfield;
  }
  
  #play {
    padding: 8px 18px;
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
  }
  
  #play:hover {
    background: var(--primary-blue-light);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
  }
  
  #play:active {
    transform: translateY(0);
  }
  
  #status { 
    font-size: 13px; 
    color: var(--text-secondary); 
    margin: 0;
    font-weight: 500;
  }
  
  #svg-container {
    position: absolute;
    top: calc(var(--panel-height) + 40px);
    left: 0;
    width: 100vw;
    height: calc(100vh - var(--panel-height) - 40px);
    z-index: 1;
  }
  
  svg { 
    width: 100%; 
    height: 100%; 
    display: block; 
    background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%);
  }
  
  .unit { 
    stroke: rgba(255, 255, 255, 0.9);
    stroke-width: 0.5px;
    cursor: pointer;
    transition: all 0.2s ease;
    shape-rendering: geometricPrecision;
  }
  
  .unit.state { fill: var(--state-color); }
  .unit.state:hover { 
    fill: var(--state-hover);
    stroke: white;
    stroke-width: 1.5px;
  }
  
  .unit.territory { fill: var(--territory-color); }
  .unit.territory:hover { 
    fill: var(--territory-hover);
    stroke: white;
    stroke-width: 1.5px;
  }
  
  .unit.other { fill: #374151; }
  .unit.other:hover {
    fill: #4b5563;
    stroke: white;
    stroke-width: 1.5px;
  }
  
  .unit.confederate { fill: var(--confederate-color); }
  .unit.confederate:hover {
    fill: var(--confederate-hover);
    stroke: white;
    stroke-width: 1.5px;
  }
  
  .event { 
    stroke: white;
    stroke-width: 2px;
    cursor: pointer;
    fill: var(--event-color);
    opacity: 0.85;
    transition: all 0.3s ease;
  } 
  
  .event:hover {
    fill: var(--event-hover);
    stroke-width: 3px;
    opacity: 1;
  }
  
  .event.highlighted {
    fill: #fbbf24;
    stroke: white;
    stroke-width: 3px;
    animation: pulse 1.5s infinite;
    opacity: 1;
  }
  
  .event.current-year {
    fill: #667eea;
    stroke: #764ba2;
    stroke-width: 4px;
    opacity: 1;
    animation: pulse 1.5s infinite alternate;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  .tooltip { 
    position: absolute; 
    pointer-events: none; 
    background: rgba(17, 24, 39, 0.97);
    backdrop-filter: blur(20px);
    color: white;
    padding: 18px 22px; 
    border-radius: 12px; 
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    max-width: 340px; 
    font-size: 14px; 
    z-index: 30;
    line-height: 1.6;
    border: 1px solid rgba(255, 255, 255, 0.15);
  }
  
  .tooltip-fixed {
    position: fixed !important;
    pointer-events: auto !important;
    max-width: 420px;
    z-index: 50;
    animation: tooltipAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .tooltip-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.15);
    border: none;
    color: white;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  
  .tooltip-close:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.1);
  }
  
  @keyframes tooltipAppear {
    from {
      opacity: 0;
      transform: translateY(10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  .tooltip h3 {
    margin: 0 0 10px 0;
    font-size: 17px;
    font-weight: 600;
    color: #fbbf24;
    letter-spacing: -0.3px;
  }
  
  .tooltip-content {
    margin-bottom: 12px;
    opacity: 0.95;
    line-height: 1.6;
  }
  
  .tooltip a { 
    color: #60a5fa; 
    text-decoration: none; 
    font-weight: 500;
    transition: color 0.2s ease;
  }
  
  .tooltip a:hover {
    color: #93c5fd;
    text-decoration: underline;
  }
  
  .legend {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--panel-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--panel-border);
    padding: 18px;
    border-radius: 12px;
    box-shadow: var(--shadow-medium);
    font-size: 13px;
    z-index: 20;
    transition: all 0.3s ease;
  }
  
  .legend:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
  }
  
  .events-list {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--panel-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--panel-border);
    padding: 22px;
    border-radius: 16px;
    box-shadow: var(--shadow-medium);
    font-size: 13px;
    max-width: 320px;
    max-height: 60vh;
    overflow-y: auto;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 20;
  }
  
  .events-list:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
  }
  
  .events-list::-webkit-scrollbar {
    width: 8px;
  }
  
  .events-list::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
  }
  
  .events-list::-webkit-scrollbar-thumb {
    background: rgba(37, 99, 235, 0.3);
    border-radius: 4px;
  }
  
  .events-list::-webkit-scrollbar-thumb:hover {
    background: rgba(37, 99, 235, 0.5);
  }
  
  .events-list-title {
    font-size: 17px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    letter-spacing: -0.3px;
  }
  
  .events-list-subtitle {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    font-weight: 500;
  }
  
  .event-item {
    padding: 10px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .event-item:last-child {
    border-bottom: none;
  }
  
  .event-item:hover {
    background: rgba(37, 99, 235, 0.08);
    border-radius: 8px;
    padding-left: 10px;
    padding-right: 10px;
    margin-left: -10px;
    margin-right: -10px;
  }
  
  .event-year {
    font-weight: 700;
    color: var(--primary-blue);
    font-size: 12px;
    letter-spacing: 0.5px;
  }
  
  .event-title {
    font-weight: 500;
    color: var(--text-primary);
    margin-top: 4px;
    line-height: 1.4;
  }
  
  .event-item.current-year {
    background: rgba(245, 158, 11, 0.12);
    border-radius: 8px;
    padding-left: 10px;
    padding-right: 10px;
    margin-left: -10px;
    margin-right: -10px;
    border-bottom: 1px solid rgba(245, 158, 11, 0.3);
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
  }
  
  .event-item.current-year .event-year {
    color: #764ba2;
    font-weight: 700;
  }
  
  .event-item.current-year .event-title {
    color: #b45309;
    font-weight: 600;
  }
  
  .no-events {
    color: var(--text-secondary);
    font-style: italic;
    text-align: center;
    padding: 24px 0;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  
  .legend-item:last-child {
    margin-bottom: 0;
  }
  
  .legend-dot {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  
  .legend-circle {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    flex-shrink: 0;
  }
  
  .legend-circle.current-year-legend {
    background: #667eea;
    border: 2px solid #764ba2;
    box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
  }
  
  .legend-item span {
    font-weight: 500;
  }
</style>
</head>
<body>

<div id="panel">
  <h2 class="panel-title">üó∫Ô∏è US History Timeline</h2>
  <div class="year-control">
    <label class="year-label" for="year">Year</label>
    <input id="year" type="range" min="1783" max="2025" step="1" value="1803">
    <span id="yearValue">1803</span>
    <input id="yearInput" type="number" min="1783" max="2025" value="1803">
    <button id="play" type="button">‚ñ∂ Play</button>
  </div>
  <div id="status">Loading map data...</div>
</div>

<div class="events-list">
  <div class="events-list-title">üìÖ Recent Events</div>
  <div class="events-list-subtitle">Past 20 years</div>
  <div id="events-container">
    <div class="no-events">Move the timeline to see events</div>
  </div>
</div>

<div class="legend">
  <div class="legend-item">
    <div class="legend-dot" style="background: var(--state-color);"></div>
    <span id="states-legend-text">States</span>
  </div>
  <div class="legend-item" id="confederate-legend" style="display: none;">
    <div class="legend-dot" style="background: var(--confederate-color);"></div>
    <span>Confederate States</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot" style="background: var(--territory-color);"></div>
    <span>Territories</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot" style="background: #374151;"></div>
    <span>Other Areas</span>
  </div>
  <div class="legend-item">
    <div class="legend-circle" style="background: var(--event-color);"></div>
    <span>Historical Events</span>
  </div>
  <div class="legend-item" id="current-year-legend" style="display: none;">
    <div class="legend-circle current-year-legend"></div>
    <span>Current Year Event</span>
  </div>
</div>

<div id="tooltip" class="tooltip" style="display:none;"></div>

<div id="svg-container">
  <svg id="svg" aria-label="Enhanced US history map"></svg>
</div>

<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>

<script>
(function() {
  const yearInput = document.getElementById('year');
  const yearValue = document.getElementById('yearValue');
  const yearInputBox = document.getElementById('yearInput');
  const statusEl = document.getElementById('status');
  const playBtn = document.getElementById('play');
  const eventsContainer = document.getElementById('events-container');

  let dataReady = false, geo = null, events = [], playing = false;
  let currentYear = +yearInput.value, fixedTooltip = null, lastRenderedYear = -1;

  const fallbackDescriptions = {
    'Alabama': 'Alabama is a state in the southeastern United States, admitted to the Union as the 22nd state in 1819.',
    'Alaska': 'Alaska is the largest state by area, purchased from Russia in 1867 and admitted as the 49th state in 1959.',
    'Arizona': 'Arizona is a southwestern state known for its desert landscape, admitted as the 48th state in 1912.',
    'California': 'California is the most populous state, admitted to the Union in 1850 following the Mexican-American War.',
    'Texas': 'Texas is the second-largest state, admitted to the Union in 1845 after being an independent republic.',
    'Florida': 'Florida is a southeastern state, admitted to the Union as the 27th state in 1845.',
    'Louisiana': 'Louisiana is a Deep South state, admitted to the Union in 1812 after the Louisiana Purchase.',
    'Louisiana Territory': 'The Louisiana Territory was acquired from France in 1803, doubling the size of the United States.',
    'Oregon Territory': 'The Oregon Territory was established in 1848, including present-day Oregon, Washington, Idaho, and parts of Montana and Wyoming.',
    'Northwest Territory': 'The Northwest Territory was established in 1787 as the first organized territory of the United States.',
    'Indian Territory': 'Indian Territory was land set aside for Native American tribes, primarily in present-day Oklahoma.'
  };

  function setYearLabel(y) {
    yearValue.textContent = y;
    yearInputBox.value = y;
  }
  
  yearValue.addEventListener('click', () => {
    yearValue.style.display = 'none';
    yearInputBox.style.display = 'block';
    yearInputBox.focus();
    yearInputBox.select();
  });
  
  yearInputBox.addEventListener('blur', () => {
    yearInputBox.style.display = 'none';
    yearValue.style.display = 'block';
    updateYear(+yearInputBox.value);
  });
  
  yearInputBox.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') yearInputBox.blur();
  });
  
  function updateYear(newYear) {
    newYear = Math.max(1783, Math.min(2025, newYear));
    currentYear = newYear;
    yearInput.value = newYear;
    setYearLabel(newYear);
    scheduleRender();
  }

  setYearLabel(currentYear);

  const stateWikiMapping = {
    'Alabama': {wiki: 'Alabama'}, 'Alaska': {wiki: 'Alaska'}, 'Arizona': {wiki: 'Arizona'},
    'California': {wiki: 'California'}, 'Texas': {wiki: 'Texas'}, 'Florida': {wiki: 'Florida'},
    'Louisiana': {wiki: 'Louisiana'}, 'Louisiana Territory': {wiki: 'Louisiana_Territory'},
    'Oregon Territory': {wiki: 'Oregon_Territory'}, 'Northwest Territory': {wiki: 'Northwest_Territory'},
    'Indian Territory': {wiki: 'Indian_Territory'}, 'Dakota Territory': {wiki: 'Dakota_Territory'}
  };
  
  function summarizeText(text, maxSentences = 3) {
    if (!text || text.trim() === '') return null;
    text = text.replace(/\s+/g, ' ').trim();
    const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
    if (sentences.length === 0) return null;
    let summary = sentences.slice(0, maxSentences).join(' ');
    if (sentences.length > maxSentences) summary += '..';
    if (summary.length > 350) summary = summary.substring(0, 350) + '...';
    return summary;
  }

  const wikiCache = {}, stateWikiCache = {};

  async function getWikiExtract(title) {
    if (wikiCache[title]) return wikiCache[title];
    const url = `https://en.wikipedia.org/w/api.php?action=query&origin=*&prop=extracts&exintro&explaintext&format=json&titles=${encodeURIComponent(title)}`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      const pages = data.query.pages;
      const page = pages[Object.keys(pages)[0]];
      if (!page || !page.extract || page.extract.trim() === '') {
        wikiCache[title] = "Description not available. Click the Wikipedia link to learn more.";
        return wikiCache[title];
      }
      const summarized = summarizeText(page.extract, 3);
      wikiCache[title] = summarized || "Description not available. Click the Wikipedia link to learn more.";
      return wikiCache[title];
    } catch (e) {
      wikiCache[title] = "Unable to load description. Please check your internet connection.";
      return wikiCache[title];
    }
  }

  async function getStateWikiExtract(stateName) {
    if (stateWikiCache[stateName]) return stateWikiCache[stateName];
    if (fallbackDescriptions[stateName]) {
      stateWikiCache[stateName] = fallbackDescriptions[stateName];
      return stateWikiCache[stateName];
    }
    const stateInfo = stateWikiMapping[stateName];
    const searchTitle = stateInfo ? stateInfo.wiki : stateName.replace(/\s+/g, '_');
    const url = `https://en.wikipedia.org/w/api.php?action=query&origin=*&prop=extracts&exintro&explaintext&format=json&titles=${encodeURIComponent(searchTitle)}`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      const pages = data.query.pages;
      const page = pages[Object.keys(pages)[0]];
      if (!page || !page.extract || page.extract.trim() === '') {
        stateWikiCache[stateName] = `${stateName} was a historical territory or state. Click the Wikipedia link to learn more.`;
        return stateWikiCache[stateName];
      }
      const summarized = summarizeText(page.extract, 4);
      stateWikiCache[stateName] = summarized || `${stateName} was a historical territory or state. Click the Wikipedia link to learn more.`;
      return stateWikiCache[stateName];
    } catch (e) {
      stateWikiCache[stateName] = `Unable to load description for ${stateName}. Please check your internet connection.`;
      return stateWikiCache[stateName];
    }
  }

  const svg = d3.select('#svg');
  let width = window.innerWidth, height = window.innerHeight - 180;
  svg.attr('viewBox', `0 0 ${width} ${height}`);
  
  const projection = d3.geoAlbersUsa().translate([width/2, height/2]).scale(Math.min(width, height) * 1.6);
  const path = d3.geoPath().projection(projection);
  const tooltip = d3.select('#tooltip');
  const gBound = svg.append('g').attr('id','bounds');
  const gEvents = svg.append('g').attr('id','events');

  function classifyUnit(d, yr){
    const t = (d.properties.TERR_TYPE || '').toLowerCase();
    const name = d.properties.FULL_NAME || d.properties.NAME || '';
    if (yr >= 1861 && yr <= 1865) {
      const confederate = ['South Carolina','Mississippi','Florida','Alabama','Georgia','Louisiana','Texas','Virginia','Arkansas','North Carolina','Tennessee'];
      if (name.includes('West Virginia')) return 'state';
      if (confederate.some(c => name.includes(c))) return 'confederate';
    }
    if (t.includes('state')) return 'state';
    if (t.includes('territory')) return 'territory';
    return 'other';
  }

  function getTypeText(d, yr) {
    const type = classifyUnit(d, yr);
    if (yr >= 1861 && yr <= 1865) {
      if (type === 'state') return 'Union State';
      if (type === 'confederate') return 'Confederate State';
      if (type === 'territory') return 'Territory';
      return 'Area';
    }
    if (type === 'state' || type === 'confederate') return 'State';
    if (type === 'territory') return 'Territory';
    return 'Area';
  }
  
  function featureKey(d){
    const p = d.properties || {};
    const bounds = path.bounds(d);
    const bStr = bounds ? `${bounds[0][0]},${bounds[0][1]},${bounds[1][0]},${bounds[1][1]}` : 'nobounds';
    return (p.FIPS||p.STATE||p.FULL_NAME||p.NAME||'unit')+':'+(p._startYear??'?')+':'+(p._endYear??'?')+':'+bStr;
  }

  function closeFixedTooltip() {
    if (fixedTooltip) {
      fixedTooltip.style('display', 'none').classed('tooltip-fixed', false);
      fixedTooltip = null;
    }
  }

  function updateEventsList(year) {
    const startYear = Math.max(1776, year - 20);
    const recentEvents = events.filter(e => e.year >= startYear && e.year <= year);
    recentEvents.sort((a, b) => b.year - a.year);
    
    if (recentEvents.length === 0) {
      eventsContainer.innerHTML = '<div class="no-events">No events in the past 20 years</div>';
      return;
    }
    
    const eventsToShow = recentEvents.slice(0, 10);
    eventsContainer.innerHTML = eventsToShow.map(ev => {
      const isCurrent = ev.year === year;
      return `<div class="event-item ${isCurrent?'current-year':''}" data-event='${JSON.stringify(ev).replace(/'/g, "&apos;")}'>
        <div class="event-year">${ev.year}</div>
        <div class="event-title">${ev.title}</div>
      </div>`;
    }).join('');
    
    eventsContainer.querySelectorAll('.event-item').forEach(item => {
      item.addEventListener('mouseenter', (e) => {
        if (fixedTooltip) return;
        const ev = JSON.parse(item.dataset.event.replace(/&apos;/g, "'"));
        tooltip.style('display','block')
          .html(`<h3>${ev.title} (${ev.year})</h3><div class="tooltip-content">Click for details</div>`)
          .style('left', Math.min(e.pageX+15, window.innerWidth-360)+'px')
          .style('top', Math.max(e.pageY-50, 20)+'px');
      });
      item.addEventListener('mouseleave', () => {
        if (!fixedTooltip) tooltip.style('display','none');
      });
      item.addEventListener('click', async (e) => {
        const ev = JSON.parse(item.dataset.event.replace(/&apos;/g, "'"));
        closeFixedTooltip();
        tooltip.style('display','block').classed('tooltip-fixed',true)
          .html(`<button class="tooltip-close">√ó</button><h3>${ev.title} (${ev.year})</h3><div class="tooltip-content">Loading...</div>`)
          .style('left', Math.min(e.pageX+15, window.innerWidth-440)+'px')
          .style('top', Math.max(e.pageY-50, 20)+'px');
        fixedTooltip = tooltip;
        tooltip.select('.tooltip-close').on('click', closeFixedTooltip);
        const extract = ev.desc || await getWikiExtract(ev.wiki);
        if (fixedTooltip === tooltip) {
          tooltip.html(`<button class="tooltip-close">√ó</button><h3>${ev.title} (${ev.year})</h3>
            <div class="tooltip-content">${extract}</div>
            <div style="margin-top:14px"><a target="_blank" href="https://en.wikipedia.org/wiki/${ev.wiki}">Read more on Wikipedia ‚Üí</a></div>`);
          tooltip.select('.tooltip-close').on('click', closeFixedTooltip);
        }
      });
    });
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.tooltip') && !e.target.closest('.event') && !e.target.closest('.event-item')) {
      closeFixedTooltip();
    }
  });

  let renderTimeout;
  function scheduleRender() {
    if (renderTimeout) clearTimeout(renderTimeout);
    renderTimeout = setTimeout(() => {
      if (currentYear !== lastRenderedYear) {
        renderMap(currentYear);
        lastRenderedYear = currentYear;
      }
    }, 16);
  }

  function renderMap(year) {
    if (!dataReady) return;
    updateEventsList(year);
    
    const confLegend = document.getElementById('confederate-legend');
    const statesText = document.getElementById('states-legend-text');
    const currYrLegend = document.getElementById('current-year-legend');
    
    currYrLegend.style.display = events.filter(e => e.year === year).length > 0 ? 'flex' : 'none';
    
    if (year >= 1861 && year <= 1865) {
      confLegend.style.display = 'flex';
      statesText.textContent = 'Union States';
    } else {
      confLegend.style.display = 'none';
      statesText.textContent = 'States';
    }
    
    // Filter active features and deduplicate by state name
    const active = geo.features.filter(f => {
      const s = f.properties._startYear, e = f.properties._endYear;
      return year >= s && (year <= e || e >= 9999);
    });
    
    // Deduplicate: keep only the most recent feature for each state name
    const stateMap = new Map();
    active.forEach(f => {
      const name = f.properties.FULL_NAME || f.properties.NAME || 'unknown';
      const existing = stateMap.get(name);
      if (!existing || f.properties._startYear > existing.properties._startYear) {
        stateMap.set(name, f);
      }
    });
    const deduped = Array.from(stateMap.values());
    
    deduped.sort((a,b) => path.area(b) - path.area(a));

    const units = gBound.selectAll('path.unit').data(deduped, featureKey);
    units.exit().remove();
    const newUnits = units.enter().append('path').attr('class', d => 'unit '+classifyUnit(d,year)).attr('d', path);
    units.merge(newUnits).attr('class', d => 'unit '+classifyUnit(d,year)).attr('d', path);

    gBound.selectAll('path.unit')
      .on('mouseover', (evt,d) => {
        if (fixedTooltip) return;
        const name = d.properties.FULL_NAME || d.properties.NAME || '‚Äî';
        tooltip.style('display','block').html(`<h3>${name}</h3><div class="tooltip-content">${getTypeText(d,year)} ‚Ä¢ Click for details</div>`);
      })
      .on('mousemove', evt => {
        if (!fixedTooltip) tooltip.style('left',(evt.pageX+15)+'px').style('top',(evt.pageY+15)+'px');
      })
      .on('mouseout', () => {
        if (!fixedTooltip) tooltip.style('display','none');
      })
      .on('click', async (evt,d) => {
        evt.stopPropagation();
        closeFixedTooltip();
        const name = d.properties.FULL_NAME || d.properties.NAME || 'Unknown';
        tooltip.style('display','block').classed('tooltip-fixed',true)
          .html(`<button class="tooltip-close">√ó</button><h3>${name}</h3><div class="tooltip-content">${getTypeText(d,year)} ‚Ä¢ Loading...</div>`)
          .style('left', Math.min(evt.pageX+15, window.innerWidth-440)+'px')
          .style('top', Math.max(evt.pageY-50, 20)+'px');
        fixedTooltip = tooltip;
        tooltip.select('.tooltip-close').on('click', closeFixedTooltip);
        const desc = await getStateWikiExtract(name);
        if (fixedTooltip === tooltip) {
          const stInfo = stateWikiMapping[name];
          const wTitle = stInfo ? stInfo.wiki : name.replace(/\s+/g, '_');
          tooltip.html(`<button class="tooltip-close">√ó</button><h3>${name}</h3>
            <div class="tooltip-content">${desc}</div>
            <div style="margin-top:14px"><a target="_blank" href="https://en.wikipedia.org/wiki/${wTitle}">Read more on Wikipedia ‚Üí</a></div>`);
          tooltip.select('.tooltip-close').on('click', closeFixedTooltip);
        }
      });

    const evActive = events.filter(e => e.year <= year);
    const evSel = gEvents.selectAll('circle.event').data(evActive, d => `${d.title}|${d.year}|${d.lat}|${d.lng}`);
    evSel.exit().remove();
    const newEv = evSel.enter().append('circle')
      .attr('class', d => d.year===year ? 'event current-year' : 'event')
      .attr('r', 10)
      .attr('cx', d => { const pt = projection([+d.lng,+d.lat]); return pt ? pt[0] : -1000; })
      .attr('cy', d => { const pt = projection([+d.lng,+d.lat]); return pt ? pt[1] : -1000; })
      .style('opacity', d => { const pt = projection([+d.lng,+d.lat]); return pt ? (d.year===year?1:0.85) : 0; });
    evSel.merge(newEv)
      .attr('class', d => d.year===year ? 'event current-year' : 'event')
      .attr('cx', d => { const pt = projection([+d.lng,+d.lat]); return pt ? pt[0] : -1000; })
      .attr('cy', d => { const pt = projection([+d.lng,+d.lat]); return pt ? pt[1] : -1000; })
      .style('opacity', d => { const pt = projection([+d.lng,+d.lat]); return pt ? (d.year===year?1:0.85) : 0; });

    gEvents.selectAll('circle.event')
      .on('mouseover', (evt,d) => {
        if (fixedTooltip) return;
        const txt = d.year===currentYear ? `<h3>${d.title} (${d.year}) ‚ú®</h3><div class="tooltip-content">Happening this year! Click for details</div>` : `<h3>${d.title} (${d.year})</h3><div class="tooltip-content">Click for details</div>`;
        tooltip.style('display','block').html(txt).style('left',(evt.pageX+15)+'px').style('top',(evt.pageY+15)+'px');
      })
      .on('mousemove', evt => {
        if (!fixedTooltip) tooltip.style('left',(evt.pageX+15)+'px').style('top',(evt.pageY+15)+'px');
      })
      .on('mouseout', () => {
        if (!fixedTooltip) tooltip.style('display','none');
      })
      .on('click', async (evt,d) => {
        evt.stopPropagation();
        closeFixedTooltip();
        const isCurr = d.year===currentYear;
        const title = isCurr ? `${d.title} (${d.year}) ‚ú®` : `${d.title} (${d.year})`;
        tooltip.style('display','block').classed('tooltip-fixed',true)
          .html(`<button class="tooltip-close">√ó</button><h3>${title}</h3><div class="tooltip-content">Loading...</div>`)
          .style('left', Math.min(evt.pageX+15, window.innerWidth-440)+'px')
          .style('top', Math.max(evt.pageY-50, 20)+'px');
        fixedTooltip = tooltip;
        tooltip.select('.tooltip-close').on('click', closeFixedTooltip);
        const extract = d.desc || await getWikiExtract(d.wiki);
        if (fixedTooltip === tooltip) {
          tooltip.html(`<button class="tooltip-close">√ó</button><h3>${title}</h3>
            <div class="tooltip-content">${extract}</div>
            <div style="margin-top:14px"><a target="_blank" href="https://en.wikipedia.org/wiki/${d.wiki}">Read more on Wikipedia ‚Üí</a></div>`);
          tooltip.select('.tooltip-close').on('click', closeFixedTooltip);
        }
      });
  }

  yearInput.addEventListener('input', () => updateYear(+yearInput.value));
  playBtn.addEventListener('click', () => {
    playing = !playing;
    playBtn.textContent = playing ? '‚è∏ Pause' : '‚ñ∂ Play';
    if (playing) autoPlay();
  });

  function autoPlay(){
    if (!playing) return;
    let y = currentYear;
    const maxY = +yearInput.max;
    const tick = () => {
      if (!playing) return;
      y = Math.min(y+1, maxY);
      updateYear(y);
      if (y < maxY) setTimeout(tick, 400);
      else { playing = false; playBtn.textContent = '‚ñ∂ Play'; }
    };
    setTimeout(tick, 400);
  }

  let resizeTimeout;
  window.addEventListener('resize', () => {
    if (resizeTimeout) clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      width = window.innerWidth; 
      height = window.innerHeight - 180;
      svg.attr('viewBox', `0 0 ${width} ${height}`);
      projection.translate([width/2, height/2]).scale(Math.min(width, height) * 1.6);
      closeFixedTooltip();
      lastRenderedYear = -1;
      scheduleRender();
    }, 100);
  });

  (async function(){
    try {
      statusEl.textContent = 'Loading map data...';
      const embeddedEvents = [
        {"year":1776,"title":"Declaration of Independence","lat":39.948,"lng":-75.150,"wiki":"United_States_Declaration_of_Independence","desc":"The Declaration of Independence was adopted on July 4, 1776, declaring independence from British rule."},
        {"year":1787,"title":"Constitution signed","lat":39.948,"lng":-75.150,"wiki":"United_States_Constitution","desc":"The Constitution was signed on September 17, 1787, establishing the framework of the US government."},
        {"year":1803,"title":"Louisiana Purchase","lat":38.627,"lng":-90.199,"wiki":"Louisiana_Purchase","desc":"The Louisiana Purchase doubled the size of the United States, acquiring approximately 827,000 square miles from France."},
        {"year":1812,"title":"War of 1812 begins","lat":38.907,"lng":-77.037,"wiki":"War_of_1812","desc":"The War of 1812 was fought between the United States and Great Britain over maritime rights and trade restrictions."},
        {"year":1820,"title":"Missouri Compromise","lat":38.573,"lng":-92.603,"wiki":"Missouri_Compromise","desc":"The Missouri Compromise attempted to balance slave and free states."},
        {"year":1830,"title":"Indian Removal Act","lat":38.907,"lng":-77.037,"wiki":"Indian_Removal_Act","desc":"The Indian Removal Act authorized forced relocation of Native American tribes to lands west of the Mississippi River."},
        {"year":1846,"title":"Mexican-American War","lat":29.423,"lng":-98.495,"wiki":"Mexican‚ÄìAmerican_War","desc":"The Mexican-American War resulted in the US acquiring California, Nevada, Utah, and parts of several other states."},
        {"year":1848,"title":"California Gold Rush","lat":38.812,"lng":-120.905,"wiki":"California_Gold_Rush","desc":"The California Gold Rush brought hundreds of thousands of migrants to California and transformed the economy."},
        {"year":1850,"title":"Compromise of 1850","lat":38.907,"lng":-77.037,"wiki":"Compromise_of_1850","desc":"The Compromise of 1850 was a package of bills that attempted to resolve territorial and slavery controversies."},
        {"year":1854,"title":"Kansas-Nebraska Act","lat":38.907,"lng":-77.037,"wiki":"Kansas‚ÄìNebraska_Act","desc":"The Kansas-Nebraska Act allowed settlers to determine whether they would allow slavery, leading to violent conflicts."},
        {"year":1861,"title":"Civil War begins","lat":32.752,"lng":-79.874,"wiki":"Battle_of_Fort_Sumter","desc":"The Civil War began with the Confederate attack on Fort Sumter in Charleston Harbor, South Carolina."},
        {"year":1863,"title":"Gettysburg Address","lat":39.830,"lng":-77.231,"wiki":"Gettysburg_Address","desc":"President Lincoln delivered the Gettysburg Address, one of the most famous speeches in American history."},
        {"year":1865,"title":"Civil War ends","lat":38.907,"lng":-77.037,"wiki":"Conclusion_of_the_American_Civil_War","desc":"The Civil War ended with Confederate surrender, preserving the Union and ending slavery."},
        {"year":1865,"title":"13th Amendment","lat":38.907,"lng":-77.037,"wiki":"Thirteenth_Amendment_to_the_United_States_Constitution","desc":"The 13th Amendment abolished slavery throughout the United States."},
        {"year":1876,"title":"Battle of Little Bighorn","lat":45.565,"lng":-107.438,"wiki":"Battle_of_the_Little_Bighorn","desc":"A victory for the Lakota, Northern Cheyenne, and Arapaho tribes against the US 7th Cavalry."},
        {"year":1890,"title":"Wounded Knee","lat":43.148,"lng":-102.368,"wiki":"Wounded_Knee_Massacre","desc":"The Wounded Knee Massacre marked the end of the Indian Wars."},
        {"year":1898,"title":"Spanish-American War","lat":25.774,"lng":-80.197,"wiki":"Spanish‚ÄìAmerican_War","desc":"The Spanish-American War resulted in the US acquiring Puerto Rico, Guam, and the Philippines."},
        {"year":1917,"title":"US enters WWI","lat":38.907,"lng":-77.037,"wiki":"United_States_entry_into_World_War_I","desc":"The United States entered World War I in April 1917, tipping the balance in favor of the Allies."},
        {"year":1920,"title":"19th Amendment","lat":38.907,"lng":-77.037,"wiki":"Nineteenth_Amendment_to_the_United_States_Constitution","desc":"The 19th Amendment granted women the right to vote nationwide."},
        {"year":1929,"title":"Stock Market Crash","lat":40.706,"lng":-74.009,"wiki":"Wall_Street_Crash_of_1929","desc":"The 1929 crash triggered the Great Depression, the worst economic downturn in modern history."},
        {"year":1933,"title":"New Deal begins","lat":38.907,"lng":-77.037,"wiki":"New_Deal","desc":"President Franklin D. Roosevelt launched the New Deal to combat the Great Depression."},
        {"year":1941,"title":"Pearl Harbor","lat":21.364,"lng":-157.95,"wiki":"Attack_on_Pearl_Harbor","desc":"The Japanese attack on Pearl Harbor brought the United States into World War II."},
        {"year":1944,"title":"D-Day","lat":49.414,"lng":-0.818,"wiki":"Normandy_landings","desc":"D-Day marked the beginning of the liberation of Western Europe from Nazi control."},
        {"year":1945,"title":"Atomic bombing","lat":34.391,"lng":132.451,"wiki":"Atomic_bombings_of_Hiroshima_and_Nagasaki","desc":"The atomic bombings of Hiroshima and Nagasaki led to Japan's surrender and the end of WWII."},
        {"year":1945,"title":"UN founded","lat":40.749,"lng":-73.968,"wiki":"History_of_the_United_Nations","desc":"The United Nations was established to promote international cooperation."},
        {"year":1950,"title":"Korean War","lat":37.566,"lng":126.978,"wiki":"Korean_War","desc":"The Korean War began when North Korea invaded South Korea."},
        {"year":1954,"title":"Brown v. Board","lat":39.047,"lng":-95.678,"wiki":"Brown_v._Board_of_Education","desc":"The Supreme Court ruled that racial segregation in public schools was unconstitutional."},
        {"year":1963,"title":"March on Washington","lat":38.889,"lng":-77.035,"wiki":"March_on_Washington_for_Jobs_and_Freedom","desc":"The march culminated in Martin Luther King Jr.'s 'I Have a Dream' speech."},
        {"year":1964,"title":"Civil Rights Act","lat":38.907,"lng":-77.037,"wiki":"Civil_Rights_Act_of_1964","desc":"The Civil Rights Act outlawed discrimination based on race, color, religion, sex, or national origin."},
        {"year":1969,"title":"Moon landing","lat":28.572,"lng":-80.648,"wiki":"Apollo_11","desc":"Apollo 11 successfully landed the first humans on the Moon."},
        {"year":1972,"title":"Watergate","lat":38.907,"lng":-77.037,"wiki":"Watergate_scandal","desc":"The Watergate scandal led to President Nixon's resignation."},
        {"year":1989,"title":"Berlin Wall falls","lat":52.516,"lng":13.377,"wiki":"Fall_of_the_Berlin_Wall","desc":"The fall of the Berlin Wall symbolized the end of the Cold War."},
        {"year":1991,"title":"Gulf War","lat":29.375,"lng":47.977,"wiki":"Gulf_War","desc":"The Gulf War liberated Kuwait from Iraqi occupation."},
        {"year":2001,"title":"9/11 attacks","lat":40.711,"lng":-74.013,"wiki":"September_11_attacks","desc":"The September 11 terrorist attacks resulted in nearly 3,000 deaths and reshaped American foreign policy."},
        {"year":2008,"title":"Financial Crisis","lat":40.706,"lng":-74.009,"wiki":"Financial_crisis_of_2007‚Äì2008","desc":"The 2008 financial crisis caused the Great Recession."},
        {"year":2020,"title":"COVID-19 pandemic","lat":40.712,"lng":-74.006,"wiki":"COVID-19_pandemic_in_the_United_States","desc":"The COVID-19 pandemic caused widespread disruption across the United States."}
      ];
      const DATA_URL = 'https://raw.githubusercontent.com/lmullen/historical-us-boundaries/master/us.json';
      const topo = await fetch(DATA_URL).then(r => r.json());
      geo = topojson.feature(topo, topo.objects.states);
      
      // List of current 50 states that should display through 2025
      const currentStates = [
        'Alabama','Alaska','Arizona','Arkansas','California','Colorado','Connecticut','Delaware',
        'Florida','Georgia','Hawaii','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky',
        'Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi',
        'Missouri','Montana','Nebraska','Nevada','New Hampshire','New Jersey','New Mexico',
        'New York','North Carolina','North Dakota','Ohio','Oklahoma','Oregon','Pennsylvania',
        'Rhode Island','South Carolina','South Dakota','Tennessee','Texas','Utah','Vermont',
        'Virginia','Washington','West Virginia','Wisconsin','Wyoming'
      ];
      
      geo.features.forEach(f => {
        const p = f.properties || {};
        p._startYear = p.START_DATE ? +String(p.START_DATE).slice(0,4) : -9999;
        p._endYear = p.END_DATE ? +String(p.END_DATE).slice(0,4) : 9999;
        
        // Extend current states to 2025 if their end date is before that
        const name = p.FULL_NAME || p.NAME || '';
        const isCurrentState = currentStates.some(state => name.includes(state));
        const isState = (p.TERR_TYPE || '').toLowerCase().includes('state');
        
        if (isCurrentState && isState && p._endYear < 2025) {
          p._endYear = 2025;
        }
      });
      events = embeddedEvents;
      dataReady = true;
      statusEl.textContent = 'Ready! Drag the slider or press Play to explore US history.';
      scheduleRender();
    } catch (e) {
      console.error('Load failed:', e);
      statusEl.textContent = 'Failed to load map data. Please check your connection.';
    }
  })();
})();
</script>
</body>
</html>